# Stage 1: Build openssl
Bootstrap: docker
From: debian:bullseye
Stage: builder

%post
    set -eux

    echo "==> Installing dependencies"
    apt-get update
    apt-get install -y --no-install-recommends \
        build-essential \
        ca-certificates \
        curl \
        wget \
        gnutls-bin \
        tar \
        xz-utils \
        m4 \
        perl \
        libssl-dev

    echo "==> Ensuring entropy is available"
    if ! [ -e /dev/urandom ]; then
        echo "    /dev/urandom missing — creating fallback"
        mknod -m 444 /dev/urandom c 1 9 || true
    fi

    cd /tmp

    if ! [ -d openssl-3.4.1 ]; then
        if ! [ -f openssl-3.4.1.tar.gz ]; then
            echo "==> Downloading OpenSSL 3.4.1"
            wget http://github.com/openssl/openssl/releases/download/openssl-3.4.1/openssl-3.4.1.tar.gz \
                -O openssl-3.4.1.tar.gz --no-check-certificate || {
                echo "     Download failed — please bind the tarball into the container at /tmp/openssl-3.4.1.tar.gz"
                exit 1
            }
        else
            echo "==> Found OpenSSL tarball, skipping download"
        fi
        echo "==> Extracting OpenSSL"
        tar -xf openssl-3.4.1.tar.gz
    else
        echo "==> Found existing OpenSSL source directory"
    fi

    cd openssl-3.4.1

    echo "==> Building OpenSSL"
    ./config --prefix=/opt/openssl --openssldir=/opt/openssl/ssl
    make -j16
    make install_sw

    echo "==> Installing config file and enabling default provider"
    mkdir -p /opt/openssl/ssl
    cp ./apps/openssl.cnf /opt/openssl/ssl/openssl.cnf
    sed -i 's/^# *activate = 1/activate = 1/' /opt/openssl/ssl/openssl.cnf

# Stage 2: Final container
Bootstrap: docker
From: nvcr.io/nvidia/pytorch:25.03-py3

%files from builder
    /opt/openssl /opt/openssl

%environment
    export PATH=/opt/openssl/bin:$PATH
    export LD_LIBRARY_PATH=/opt/openssl/lib64:$LD_LIBRARY_PATH
    export OPENSSL_CONF=/opt/openssl/ssl/openssl.cnf
    export OPENSSL_MODULES=/opt/openssl/lib64/ossl-modules

%post
    set -eux
    export PATH=/opt/openssl/bin:$PATH
    export LD_LIBRARY_PATH=/opt/openssl/lib64:$LD_LIBRARY_PATH
    export OPENSSL_CONF=/opt/openssl/ssl/openssl.cnf
    export OPENSSL_MODULES=/opt/openssl/lib64/ossl-modules

    echo "$(tput setaf 2)==> OpenSSL runtime environment injected$(tput sgr0)"
    /opt/openssl/bin/openssl version

    echo "$(tput setaf 3)==> Verifying OpenSSL tarball checksum (if present)$(tput sgr0)"
    if [ -f /tmp/openssl-3.4.1.tar.gz ]; then
        sha256sum /tmp/openssl-3.4.1.tar.gz || true
    else
        echo "$(tput setaf 1)Note:$(tput sgr0) OpenSSL tarball not present in final image"
    fi

%test
    set -eu

    echo "$(tput setaf 2)==> OpenSSL version test:$(tput sgr0)"
    openssl version
    openssl version | grep -q "3.4.1" || {
        echo "$(tput setaf 1)ERROR:$$(tput sgr0) OpenSSL version is incorrect"
        exit 1
    }

    echo "$(tput setaf 2)==> Python SSL context test:$(tput sgr0)"
    python3 -c "import ssl; print(ssl.create_default_context())"

    echo "$(tput setaf 2)==> Pip functionality test:$(tput sgr0)"
    python3 -m pip install --upgrade --quiet pip
    python3 -m pip install --quiet requests

    echo "$(tput setaf 2)All runtime tests passed.$(tput sgr0)"

%labels
    Author Marco Christiani
    Description PyTorch 25.03 + minimal OpenSSL 3.4.1 runtime

